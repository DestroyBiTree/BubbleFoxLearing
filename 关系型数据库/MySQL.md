## 索引

#### 1.索引为什么使用 B+树

* https://blog.csdn.net/l18848956739/article/details/106458035
* 二叉查找树(BST)：解决了排序的基本问题，但是由于无法保证平衡，可能退化为链表；
* 平衡二叉树(AVL)：通过旋转解决了平衡的问题，但是旋转操作效率太低；
*  红黑树：通过舍弃严格的平衡和引入红黑节点，解决了AVL旋转效率过低的问题，但是在磁盘等场景下，树仍然太高，IO次数太多；
* B树：通过将二叉树改为多路平衡查找树，解决了树过高的问题；
* B+树：在B树的基础上，将非叶节点改造为不存储数据的纯索引节点，进一步降低了树的高度；此外将叶节点使用指针连接成链表，范围查询更加高效。

#### 2.聚簇索引和非聚簇索引

* [聚簇索引和非聚簇索引_向程序猿进化的博客-CSDN博客_聚簇索引和非聚簇索引的区别](https://blog.csdn.net/lm1060891265/article/details/81482136)
* 聚簇索引和非聚簇索引指的是一种组织方式
* 聚簇索引就是按照每张表的主键构造一颗B+树，同时叶子节点中存放的就是整张表的行记录数据，也将聚集索引的叶子节点称为数据页。这个特性决定了索引组织表中数据也是索引的一部分，每张表只能拥有一个聚簇索引。
* 辅助索引叶子节点存储的不再是行的物理位置，而是主键值。通过辅助索引首先找到的是主键值，再通过主键值找到数据行的数据页，再通过数据页中的Page Directory找到数据行。
* Innodb辅助索引的叶子节点并不包含行记录的全部数据，叶子节点除了包含键值外，还包含了相应行数据的聚簇索引键。

#### 3.索引失效的原因

* 违反最佳左前缀法则
* 在索引列上做任何操作
  * 计算，函数，转换类型等
* 索引范围条件右边的列
* 尽量使用覆盖索引
* 使用不等于
  * != 、<>
* like 以通配符开头
  * like ’%abc‘
* 字符串不加单引号，导致类型转换
* or 连接
* order by 违反最佳左前缀，含有非索引字段排序，会导致 using filesort
* group by 违反醉驾左前缀，含有非索引字段分组，会导致临时表 using temporary

#### 2.日志

* mysql 五种日志 https://www.cnblogs.com/myseries/p/10728533.html
* 重做日志 redo log
  * 功能，主要实现事务的持续性，事务开始时，即开始记录日志，将日志记录到缓冲区（默认大小8M），之后主线程会将此日志写入磁盘
  * 防止在数据库挂掉之后，将数据时进行恢复，保持事务的持续性
  * 当事务的脏页写入磁盘后，redo log 就可以被覆盖了
* 回滚日志 undo log
  * 保证事务的原子性，用于实现事务的回滚和 MVVC 控制
  * 事务开始时，产生当前版本的 undo log，undo log 也会产生 redo log，保证 undo log 的可靠
* 二进制日志 binlog
  * 作用
    * 用于复制，在主从复制中，从库利用主库上的binlog进行重播，实现主从同步
    * 用于数据库的基于时间点的还原
  * 内容
    * 逻辑格式的日志，可以简单认为就是执行过的事务中的sql语句
    * 但又不完全是sql语句这么简单，而是包括了执行的sql语句（增删改）反向的信息，也就意味着delete对应着delete本身和其反向的insert；update对应着update执行前后的版本的信息；insert对应着delete和insert本身的信息
  * 什么时候产生
    * 事务提交的时候，一次性将事务中的sql语句（一个事物可能对应多个sql语句）按照一定的格式记录到binlog中。	
* 错误日志 error log
  * 错误日志记录着mysqld启动和停止,以及服务器在运行过程中发生的错误的相关信息。
* 普通查询日志 general query log
  * 记录了服务器接收到的每一个查询或是命令，无论这些查询或是命令是否正确甚至是否包含语法错误，general log 都会将其记录下来 ，记录的格式为 {Time ，Id ，Command，Argument }。也正因为mysql服务器需要不断地记录日志，开启General log会产生不小的系统开销。 因此，Mysql默认是把General log关闭的
* 慢查询日志
  * 慢日志记录执行时间过长和没有使用索引的查询语句，报错select、update、delete以及insert语句，慢日志只会记录执行成功的语句
* redo log 和 bin log 的区别
  * redo log是保证事务的持久性的，是事务层面的，binlog作为还原的功能，是数据库层面的（当然也可以精确到事务层面的），虽然都有还原的意思，但是其保护数据的层次是不一样的。
  * redo log是物理日志，是数据页面的修改之后的物理记录，binlog是逻辑日志，可以简单认为记录的就是sql语句
  * 另外，两者日志产生的时间，可以释放的时间，在可释放的情况下清理机制，都是完全不同的。

#### 3.数据库设计原则

* 范式 https://www.zhihu.com/question/24696366/answer/29189700
* 第一范式：1NF是对属性的原子性约束，要求属性具有原子性，不可再分解；
* 第二范式：2NF是对记录的惟一性约束，要求记录有惟一标识，即实体的惟一性；
* 第三范式：3NF是对字段冗余性的约束，即任何字段不能由其他字段派生出来，它要求字段没有冗余
* 1）、符合1NF的关系中的每个属性都不可再分。
  2）、2NF在1NF的基础之上，消除了非主属性对于码的部分函数依赖。
  3）、3NF在2NF的基础之上，消除了非主属性对于码的传递函数依赖
* 2NF，满足1NF,表中的字段必须完全依赖于全部主键而非部分主键 (一般我们都会做到)
* 3NF，满足2NF,非主键外的所有字段必须互不依赖

#### 4.数据库的多版本控制

* MVVC 可重读和读已提交 https://zhuanlan.zhihu.com/p/336813209
* 读已提交，每次在读取的时候都生成一个 ReadView
  * 这里面保存了当前活跃的会话 id，以及最小id和下一个较大的id值。在读取数据是，会看当前值的活跃id列表，如果当前版本的id在活跃列表中，那么就读取下一个版本，直到某一个版本的id不在活跃列表，即可读取
  * 当事务提交了之后，活跃列表里的id即会删除，因此再次读取时，即可读取到已提交的事务数据
* 可重复读，在第一次读取时生成一个 ReadView
  * 这里面的信息，不会更改，因此每次读取都是同一个版本的数据
* 版本信息存储在 undo 日志中

## 数据类型

#### 数值类型

| 类型         | 大小                                     | 范围（有符号）                                               | 范围（无符号）                                               | 用途            |
| :----------- | :--------------------------------------- | :----------------------------------------------------------- | :----------------------------------------------------------- | :-------------- |
| TINYINT      | 1 Bytes                                  | (-128，127)                                                  | (0，255)                                                     | 小整数值        |
| SMALLINT     | 2 Bytes                                  | (-32 768，32 767)                                            | (0，65 535)                                                  | 大整数值        |
| MEDIUMINT    | 3 Bytes                                  | (-8 388 608，8 388 607)                                      | (0，16 777 215)                                              | 大整数值        |
| INT或INTEGER | 4 Bytes                                  | (-2 147 483 648，2 147 483 647)                              | (0，4 294 967 295)                                           | 大整数值        |
| BIGINT       | 8 Bytes                                  | (-9,223,372,036,854,775,808，9 223 372 036 854 775 807)      | (0，18 446 744 073 709 551 615)                              | 极大整数值      |
| FLOAT        | 4 Bytes                                  | (-3.402 823 466 E+38，-1.175 494 351 E-38)，0，(1.175 494 351 E-38，3.402 823 466 351 E+38) | 0，(1.175 494 351 E-38，3.402 823 466 E+38)                  | 单精度 浮点数值 |
| DOUBLE       | 8 Bytes                                  | (-1.797 693 134 862 315 7 E+308，-2.225 073 858 507 201 4 E-308)，0，(2.225 073 858 507 201 4 E-308，1.797 693 134 862 315 7 E+308) | 0，(2.225 073 858 507 201 4 E-308，1.797 693 134 862 315 7 E+308) | 双精度 浮点数值 |
| DECIMAL      | 对DECIMAL(M,D) ，如果M>D，为M+2否则为D+2 | 依赖于M和D的值                                               | 依赖于M和D的值                                               | 小数值          |

#### 时间类型

| 类型      | 大小 ( bytes) | 范围                                                         | 格式                | 用途                     |
| :-------- | :------------ | :----------------------------------------------------------- | :------------------ | :----------------------- |
| DATE      | 3             | 1000-01-01/9999-12-31                                        | YYYY-MM-DD          | 日期值                   |
| TIME      | 3             | '-838:59:59'/'838:59:59'                                     | HH:MM:SS            | 时间值或持续时间         |
| YEAR      | 1             | 1901/2155                                                    | YYYY                | 年份值                   |
| DATETIME  | 8             | 1000-01-01 00:00:00/9999-12-31 23:59:59                      | YYYY-MM-DD HH:MM:SS | 混合日期和时间值         |
| TIMESTAMP | 4             | 1970-01-01 00:00:00/2038结束时间是第 **2147483647** 秒，北京时间 **2038-1-19 11:14:07**，格林尼治时间 2038年1月19日 凌晨 03:14:07 | YYYYMMDD HHMMSS     | 混合日期和时间值，时间戳 |

#### 字符串类型

| CHAR       | 0-255 bytes           | 定长字符串                      |
| ---------- | --------------------- | ------------------------------- |
| VARCHAR    | 0-65535 bytes         | 变长字符串                      |
| TINYBLOB   | 0-255 bytes           | 不超过 255 个字符的二进制字符串 |
| TINYTEXT   | 0-255 bytes           | 短文本字符串                    |
| BLOB       | 0-65 535 bytes        | 二进制形式的长文本数据          |
| TEXT       | 0-65 535 bytes        | 长文本数据                      |
| MEDIUMBLOB | 0-16 777 215 bytes    | 二进制形式的中等长度文本数据    |
| MEDIUMTEXT | 0-16 777 215 bytes    | 中等长度文本数据                |
| LONGBLOB   | 0-4 294 967 295 bytes | 二进制形式的极大文本数据        |
| LONGTEXT   | 0-4 294 967 295 bytes | 极大文本数据                    |
